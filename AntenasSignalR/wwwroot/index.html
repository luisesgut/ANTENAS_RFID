<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>EPCs de Antenas RFID</title>
</head>
<body>
    <div id="content1"></div>

    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@3.1.8/dist/browser/signalr.min.js"></script>
    <script src="https://unpkg.com/rxjs@^7/dist/bundles/rxjs.umd.min.js"></script>

    <script type="text/javascript">
        const subject = new rxjs.Subject();

        // Función para obtener la información del EPC
        async function fetchEpcData(epc) {
            try {
                const response = await fetch(`http://172.16.10.31/api/socket/${epc}`);
                if (response.ok) {
                    const data = await response.json();
                    return data;
                } else {
                    console.error("Error al obtener los datos del EPC:", response.statusText);
                    return null;
                }
            } catch (error) {
                console.error("Error al conectarse con el endpoint:", error);
                return null;
            }
        }

        // Función para mostrar la información del EPC
        function displayEpcData(epc, data) {
            // Crear un contenedor para el EPC y sus datos
            const epcContainer = document.createElement('div');
            epcContainer.style.marginBottom = "20px"; // Espacio entre EPCs

            // Mostrar el EPC en un elemento <b>
            const epcElement = document.createElement('b');
            epcElement.textContent = `[EPC]: ${epc}`;
            epcContainer.appendChild(epcElement);

            // Crear una lista para los datos del endpoint
            const dataList = document.createElement('ul');

            // Agregar los elementos de la lista
            const areaItem = document.createElement('li');
            areaItem.textContent = `Área: ${data.area}`;
            dataList.appendChild(areaItem);

            const fechaItem = document.createElement('li');
            fechaItem.textContent = `Fecha: ${data.fecha}`;
            dataList.appendChild(fechaItem);

            const claveProductoItem = document.createElement('li');
            claveProductoItem.textContent = `Clave Producto: ${data.claveProducto}`;
            dataList.appendChild(claveProductoItem);

            const nombreProductoItem = document.createElement('li');
            nombreProductoItem.textContent = `Nombre Producto: ${data.nombreProducto}`;
            dataList.appendChild(nombreProductoItem);

            const pesoNetoItem = document.createElement('li');
            pesoNetoItem.textContent = `Peso Neto: ${data.pesoNeto} kg`;
            dataList.appendChild(pesoNetoItem);

            const piezasItem = document.createElement('li');
            piezasItem.textContent = `Piezas: ${data.piezas}`;
            dataList.appendChild(piezasItem);

            // Agregar la lista al contenedor
            epcContainer.appendChild(dataList);

            // Agregar el contenedor a content1
            document.getElementById("content1").appendChild(epcContainer);
        }

        subject.subscribe(async (message) => {
            // Extraer el EPC del mensaje
            const epc = message.split('EPC: ')[1];  // Asumiendo que el mensaje tiene el formato: "[Antenna] EPC: 0002417019867005"

            // Mostrar el EPC primero
            const epcContainer = document.createElement('div');
            epcContainer.innerHTML = `<b>${message}</b>`;
            document.getElementById("content1").appendChild(epcContainer);

            // Hacer la solicitud al endpoint
            const epcData = await fetchEpcData(epc);
            if (epcData) {
                displayEpcData(epc, epcData);
            }
        });

        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/message")
            .build();

        connection.start().then(() => {
            console.log("Conectado");
        }).catch((err) => console.error(err.toString()));

        connection.on("sendMessage", (message) => {
            console.log(message);
            subject.next(message);
        });
    </script>
</body>
</html>
